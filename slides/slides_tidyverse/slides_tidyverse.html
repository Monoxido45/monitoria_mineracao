<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Oficina de Tidyverse</title>
    <meta charset="utf-8" />
    <meta name="author" content="Luben Miguel" />
    <meta name="date" content="2022-10-06" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# Oficina de Tidyverse
]
.author[
### Luben Miguel
]
.institute[
### Universidade Federal de São Carlos
]
.date[
### 10/06/2022
]

---






# O que é o Tidyverse?

--

- O `{tidyverse}` é um conjunto de pacotes para ciência de dados.

--

- Fazem parte do `{tidyverse}`: `{ggplot2}`, `{dplyr}`, `{tidyr}`, `{purrr}`, `{readr}`, e assim vai...

--
&lt;center&gt;
&lt;img src="https://miro.medium.com/max/917/0*OY7eFSIP42EiNXED" width="300px"&gt;
&lt;/center&gt;

--

- Pacotes com mesma sintaxe e estilo de programar, usados em conjunto

--

- Seguem o *manifesto tidy* e trabalham em torno de *bases tidy*

---
## Manifesto tidy
1. Reutilizar estruturas de dados existentes

2. Organizar funções simples usando o pipe (%&gt;%)

3. Aderir à programação funcional

4. Projetado para ser usado por seres humanos.

--

## Base tidy
- Base onde é possível trabalhar com dados de uma maneira simples e eficiente
  - Cada coluna representa uma variável
  
  - Cada linha uma observação
  
  - Cada cédula um único valor


---
class: middle
## Resumão do que alguns pacotes fazem

.pull-left[
&lt;div class='flex-favicon'&gt;
&lt;img src="https://d33wubrfki0l68.cloudfront.net/c1c91484f898fe9d7d90a570900f1d5cd703fe2e/d7df4/css/images/hex/readr.png" width="85px" float='left'&gt;
&lt;div style="display:inline-block;"&gt;
&lt;p&gt;{readr}: Ler dados em formato tabular &lt;/p&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;div class='flex-favicon'&gt;
&lt;img src="https://d33wubrfki0l68.cloudfront.net/476fa4025501dcec05be08248b32d390dd2337d5/574c6/css/images/hex/tidyr.png" width="85px" float='left'&gt;
&lt;div style="display:inline-block;"&gt;
&lt;p&gt;{tidyr}: Arrumar e padronizar dados&lt;/p&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;div class='flex-favicon'&gt;
&lt;img src="https://d33wubrfki0l68.cloudfront.net/621a9c8c5d7b47c4b6d72e8f01f28d14310e8370/193fc/css/images/hex/dplyr.png" width="85px" float='left'&gt;
&lt;div style="display:inline-block;"&gt;
&lt;p&gt;{dplyr}: transformar dados&lt;/p&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;div class='flex-favicon'&gt;
&lt;img src="https://d33wubrfki0l68.cloudfront.net/2c6239d311be6d037c251c71c3902792f8c4ddd2/12f67/css/images/hex/ggplot2.png" width="85px" float='left'&gt;
&lt;div style="display:inline-block;"&gt;
&lt;p&gt;{ggplot2}: criar gráficos&lt;/p&gt;&lt;/div&gt;
&lt;/div&gt;
]

.pull-right[
&lt;div class='flex-favicon'&gt;
&lt;img src="https://d33wubrfki0l68.cloudfront.net/2d0701b616efa7435cd5a94e703baa595a4f9ed0/d41b9/css/images/hex/purrr.png" width="85px" float='left'&gt;
&lt;div style="display:inline-block;"&gt;
&lt;p&gt;{purrr}: Programação funcional&lt;/p&gt;&lt;/div&gt;
&lt;/div&gt;


&lt;div class='flex-favicon'&gt;
&lt;img src="https://d33wubrfki0l68.cloudfront.net/45fd04ad9cdb2159fea08d07dbc11e742d68e4e3/df327/css/images/hex/stringr.png" width="85px" float='left'&gt;
&lt;div style="display:inline-block;"&gt;
&lt;p&gt;{stringr}: Lidar com strings&lt;/p&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;div class='flex-favicon'&gt;
&lt;img src="https://d33wubrfki0l68.cloudfront.net/412a6f14518ab633a94221dda7e16cf22e43a763/91620/css/images/hex/forcats.png" width="85px" float='left'&gt;
&lt;div style="display:inline-block;"&gt;
&lt;p&gt;{forcats}: Lidar com fatores&lt;/p&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;div class='flex-favicon'&gt;
&lt;img src="https://d33wubrfki0l68.cloudfront.net/c477d7eb7fdf2c3d75637cfe19ff4a4d0a107bcf/017d0/css/images/hex/tibble.png" width="85px" float='left'&gt;
&lt;div style="display:inline-block;"&gt;
&lt;p&gt;{tibble}: Data frames repaginados &lt;/p&gt;&lt;/div&gt;
&lt;/div&gt;
]
---
class: inverse, center, middle

# Pacotes preliminares


---
# Tibbles

- Tibbles são praticamente data.frames com melhorias na visualização pelo console

--

- São usadas em diversas funções e pacotes do `tidyverse`, principalmente pelos pacotes `dplyr` e `tidyr`

--

.pull-left[
- Data-frame padrão

```r
mtcars[, 1:6]
```

```
##                      mpg cyl  disp  hp drat    wt
## Mazda RX4           21.0   6 160.0 110 3.90 2.620
## Mazda RX4 Wag       21.0   6 160.0 110 3.90 2.875
## Datsun 710          22.8   4 108.0  93 3.85 2.320
## Hornet 4 Drive      21.4   6 258.0 110 3.08 3.215
## Hornet Sportabout   18.7   8 360.0 175 3.15 3.440
## Valiant             18.1   6 225.0 105 2.76 3.460
## Duster 360          14.3   8 360.0 245 3.21 3.570
## Merc 240D           24.4   4 146.7  62 3.69 3.190
## Merc 230            22.8   4 140.8  95 3.92 3.150
## Merc 280            19.2   6 167.6 123 3.92 3.440
## Merc 280C           17.8   6 167.6 123 3.92 3.440
## Merc 450SE          16.4   8 275.8 180 3.07 4.070
## Merc 450SL          17.3   8 275.8 180 3.07 3.730
## Merc 450SLC         15.2   8 275.8 180 3.07 3.780
## Cadillac Fleetwood  10.4   8 472.0 205 2.93 5.250
## Lincoln Continental 10.4   8 460.0 215 3.00 5.424
## Chrysler Imperial   14.7   8 440.0 230 3.23 5.345
## Fiat 128            32.4   4  78.7  66 4.08 2.200
## Honda Civic         30.4   4  75.7  52 4.93 1.615
## Toyota Corolla      33.9   4  71.1  65 4.22 1.835
## Toyota Corona       21.5   4 120.1  97 3.70 2.465
## Dodge Challenger    15.5   8 318.0 150 2.76 3.520
## AMC Javelin         15.2   8 304.0 150 3.15 3.435
## Camaro Z28          13.3   8 350.0 245 3.73 3.840
## Pontiac Firebird    19.2   8 400.0 175 3.08 3.845
## Fiat X1-9           27.3   4  79.0  66 4.08 1.935
## Porsche 914-2       26.0   4 120.3  91 4.43 2.140
## Lotus Europa        30.4   4  95.1 113 3.77 1.513
## Ford Pantera L      15.8   8 351.0 264 4.22 3.170
## Ferrari Dino        19.7   6 145.0 175 3.62 2.770
## Maserati Bora       15.0   8 301.0 335 3.54 3.570
## Volvo 142E          21.4   4 121.0 109 4.11 2.780
```
]
.pull-right[
- Tibble

```r
as_tibble(mtcars[, 1:6])
```

```
## # A tibble: 32 × 6
##      mpg   cyl  disp    hp  drat    wt
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1  21       6  160    110  3.9   2.62
##  2  21       6  160    110  3.9   2.88
##  3  22.8     4  108     93  3.85  2.32
##  4  21.4     6  258    110  3.08  3.22
##  5  18.7     8  360    175  3.15  3.44
##  6  18.1     6  225    105  2.76  3.46
##  7  14.3     8  360    245  3.21  3.57
##  8  24.4     4  147.    62  3.69  3.19
##  9  22.8     4  141.    95  3.92  3.15
## 10  19.2     6  168.   123  3.92  3.44
## # … with 22 more rows
```
]

---
# Operador Pipe

- Torna a escrita e leitura de códigos mais intuitiva

- Funções do tidyverse foram projetadas para serem usadas com o pipe %&gt;%

- Ideia do pipe: usar o valor resultante da expressão do lado esquerdo como primeiro argumento da função do lado direito.


```r
# expressoes equivalentes
f(x, y)
x %&gt;% f(y)
```

---
# Exemplinhos
- Vamos calcular a raiz quadrada da soma de um vetor ***x = c(1, 2, 3, 4)***:

--

```r
# sem pipe
x &lt;- c(1, 2, 3, 4)
sqrt(sum(x))
```

```
## [1] 3.162278
```

--

```r
# com pipe
x %&gt;% sum() %&gt;% sqrt()
```

```
## [1] 3.162278
```

---
# Exemplinhos
- Ajustando um modelo linear no banco de dados `airquality`:


```r
# resultado do lado esquerdo indo para outro argumento do lado direito que não o primerio
airquality %&gt;%
  na.omit() %&gt;%
  lm(Ozone ~ Wind + Temp + Solar.R, data = .)
```

```
## 
## Call:
## lm(formula = Ozone ~ Wind + Temp + Solar.R, data = .)
## 
## Coefficients:
## (Intercept)         Wind         Temp      Solar.R  
##   -64.34208     -3.33359      1.65209      0.05982
```
---
class: inverse, center, middle

# Dplyr e tidyr

---
# Dplyr
- Pacote muito úti, fácil e versatil de se usar para transformação de dados

- Diversas funções que podem ser combinadas e encadeadas pelo pipe `%&gt;%`

- Principais funções:
  - `select()`: seleciona colunas
  - `arrange()`: ordena a base de dados
  - `filter()`: filtra linhas
  - `mutate()`: cria/modifica colunas
  - `group_by()`: agrupa a base de dados de acordo com certa(s) variável(eis)
  - `summarise()`: sumariza a base de dados
  
- Características dessas funções:
  - O input o output são sempre uma tibble.
  - Tibble vai no primeiro argumento das funções e o que queremos fazer nos outros argumentos.
  - A utilização é facilitada com o emprego do operador %&gt;%.

---
# Dados
Vamos usar o banco de dados iris para ilustrar as funções do `dplyr`:

```r
# transformando antes para tibble
iris &lt;- as_tibble(iris) %&gt;% rowid_to_column()
iris
```

```
## # A tibble: 150 × 6
##    rowid Sepal.Length Sepal.Width Petal.Length Petal.Width Species
##    &lt;int&gt;        &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
##  1     1          5.1         3.5          1.4         0.2 setosa 
##  2     2          4.9         3            1.4         0.2 setosa 
##  3     3          4.7         3.2          1.3         0.2 setosa 
##  4     4          4.6         3.1          1.5         0.2 setosa 
##  5     5          5           3.6          1.4         0.2 setosa 
##  6     6          5.4         3.9          1.7         0.4 setosa 
##  7     7          4.6         3.4          1.4         0.3 setosa 
##  8     8          5           3.4          1.5         0.2 setosa 
##  9     9          4.4         2.9          1.4         0.2 setosa 
## 10    10          4.9         3.1          1.5         0.1 setosa 
## # … with 140 more rows
```

---
# Selecionando colunas

- Usando a função `select()`
- Primeiro argumento é a base e os demais são as variáveis a serem selecionadas
.pull-left[
Selecionando uma coluna:

```r
iris %&gt;% select(Sepal.Length)
```

```
## # A tibble: 150 × 1
##    Sepal.Length
##           &lt;dbl&gt;
##  1          5.1
##  2          4.9
##  3          4.7
##  4          4.6
##  5          5  
##  6          5.4
##  7          4.6
##  8          5  
##  9          4.4
## 10          4.9
## # … with 140 more rows
```
]
.pull-right[
Selecionando mais de uma:

```r
# iris %&gt;% select(1,2)
iris %&gt;% select(Sepal.Length, Sepal.Width)
```

```
## # A tibble: 150 × 2
##    Sepal.Length Sepal.Width
##           &lt;dbl&gt;       &lt;dbl&gt;
##  1          5.1         3.5
##  2          4.9         3  
##  3          4.7         3.2
##  4          4.6         3.1
##  5          5           3.6
##  6          5.4         3.9
##  7          4.6         3.4
##  8          5           3.4
##  9          4.4         2.9
## 10          4.9         3.1
## # … with 140 more rows
```
]

---
# Selecionando colunas

Selecionando um intervalo de variaveis

```r
iris %&gt;% select(Sepal.Length:Petal.Length)
```

```
## # A tibble: 150 × 3
##    Sepal.Length Sepal.Width Petal.Length
##           &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;
##  1          5.1         3.5          1.4
##  2          4.9         3            1.4
##  3          4.7         3.2          1.3
##  4          4.6         3.1          1.5
##  5          5           3.6          1.4
##  6          5.4         3.9          1.7
##  7          4.6         3.4          1.4
##  8          5           3.4          1.5
##  9          4.4         2.9          1.4
## 10          4.9         3.1          1.5
## # … with 140 more rows
```

---
# Selecionando colunas

Também podemos remover variaveis:

```r
iris %&gt;% select(-Sepal.Length)
```

```
## # A tibble: 150 × 5
##    rowid Sepal.Width Petal.Length Petal.Width Species
##    &lt;int&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
##  1     1         3.5          1.4         0.2 setosa 
##  2     2         3            1.4         0.2 setosa 
##  3     3         3.2          1.3         0.2 setosa 
##  4     4         3.1          1.5         0.2 setosa 
##  5     5         3.6          1.4         0.2 setosa 
##  6     6         3.9          1.7         0.4 setosa 
##  7     7         3.4          1.4         0.3 setosa 
##  8     8         3.4          1.5         0.2 setosa 
##  9     9         2.9          1.4         0.2 setosa 
## 10    10         3.1          1.5         0.1 setosa 
## # … with 140 more rows
```

---
# Selecionando colunas

Algumas funções suplementares que ajudam na seleção de variáveis:

  * `starts_with()`: colunas que começam com um prefixo
  
  * `ends_with()`: colunas que terminam com um sufixo
  
  * `contains()`: colunas que contêm uma string
  
  * `last_col()`: última coluna
  

```r
iris %&gt;% select(starts_with("Petal"))
```

```
## # A tibble: 150 × 2
##    Petal.Length Petal.Width
##           &lt;dbl&gt;       &lt;dbl&gt;
##  1          1.4         0.2
##  2          1.4         0.2
##  3          1.3         0.2
##  4          1.5         0.2
##  5          1.4         0.2
##  6          1.7         0.4
##  7          1.4         0.3
##  8          1.5         0.2
##  9          1.4         0.2
## 10          1.5         0.1
## # … with 140 more rows
```
---
# Ordenando a base

- Com `arrange()`ordenamos as linhas de acordo com alguma variável de interesse:

  - Variável categórica: ordena por ordem alfabética
  
  - Variável numérica: ordena do menor para o maior
  
  - Varíavel fator: ordena pelos níveis do fator
  
  

```r
iris %&gt;% arrange(Sepal.Length)
```

```
## # A tibble: 150 × 6
##    rowid Sepal.Length Sepal.Width Petal.Length Petal.Width Species
##    &lt;int&gt;        &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
##  1    14          4.3         3            1.1         0.1 setosa 
##  2     9          4.4         2.9          1.4         0.2 setosa 
##  3    39          4.4         3            1.3         0.2 setosa 
##  4    43          4.4         3.2          1.3         0.2 setosa 
##  5    42          4.5         2.3          1.3         0.3 setosa 
##  6     4          4.6         3.1          1.5         0.2 setosa 
##  7     7          4.6         3.4          1.4         0.3 setosa 
##  8    23          4.6         3.6          1           0.2 setosa 
##  9    48          4.6         3.2          1.4         0.2 setosa 
## 10     3          4.7         3.2          1.3         0.2 setosa 
## # … with 140 more rows
```

---
# Ordenando a base

Ordenando de forma decrescente

```r
iris %&gt;% arrange(desc(Sepal.Length))
```

```
## # A tibble: 150 × 6
##    rowid Sepal.Length Sepal.Width Petal.Length Petal.Width Species  
##    &lt;int&gt;        &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;    
##  1   132          7.9         3.8          6.4         2   virginica
##  2   118          7.7         3.8          6.7         2.2 virginica
##  3   119          7.7         2.6          6.9         2.3 virginica
##  4   123          7.7         2.8          6.7         2   virginica
##  5   136          7.7         3            6.1         2.3 virginica
##  6   106          7.6         3            6.6         2.1 virginica
##  7   131          7.4         2.8          6.1         1.9 virginica
##  8   108          7.3         2.9          6.3         1.8 virginica
##  9   110          7.2         3.6          6.1         2.5 virginica
## 10   126          7.2         3.2          6           1.8 virginica
## # … with 140 more rows
```

---
# Ordenando a base

Ordenando por mais de uma variável

```r
iris %&gt;% arrange(Species, Sepal.Length)
```

```
## # A tibble: 150 × 6
##    rowid Sepal.Length Sepal.Width Petal.Length Petal.Width Species
##    &lt;int&gt;        &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
##  1    14          4.3         3            1.1         0.1 setosa 
##  2     9          4.4         2.9          1.4         0.2 setosa 
##  3    39          4.4         3            1.3         0.2 setosa 
##  4    43          4.4         3.2          1.3         0.2 setosa 
##  5    42          4.5         2.3          1.3         0.3 setosa 
##  6     4          4.6         3.1          1.5         0.2 setosa 
##  7     7          4.6         3.4          1.4         0.3 setosa 
##  8    23          4.6         3.6          1           0.2 setosa 
##  9    48          4.6         3.2          1.4         0.2 setosa 
## 10     3          4.7         3.2          1.3         0.2 setosa 
## # … with 140 more rows
```

---
# Filtrando linhas
- Usamos `filter()` para selecionar as linhas de acordo com certa condição (filtro)


```r
iris %&gt;% filter(Sepal.Length &gt; 6)
```

```
## # A tibble: 61 × 6
##    rowid Sepal.Length Sepal.Width Petal.Length Petal.Width Species   
##    &lt;int&gt;        &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;     
##  1    51          7           3.2          4.7         1.4 versicolor
##  2    52          6.4         3.2          4.5         1.5 versicolor
##  3    53          6.9         3.1          4.9         1.5 versicolor
##  4    55          6.5         2.8          4.6         1.5 versicolor
##  5    57          6.3         3.3          4.7         1.6 versicolor
##  6    59          6.6         2.9          4.6         1.3 versicolor
##  7    64          6.1         2.9          4.7         1.4 versicolor
##  8    66          6.7         3.1          4.4         1.4 versicolor
##  9    69          6.2         2.2          4.5         1.5 versicolor
## 10    72          6.1         2.8          4           1.3 versicolor
## # … with 51 more rows
```

---
# Filtrando linhas
- Combinando filter, select e arrange para analisar os individuos que tem tamanho de sépala maior que 6:

```r
iris %&gt;% filter(Sepal.Length &gt; 6) %&gt;%
  select(rowid, Sepal.Length) %&gt;%
  arrange(desc(Sepal.Length))
```

```
## # A tibble: 61 × 2
##    rowid Sepal.Length
##    &lt;int&gt;        &lt;dbl&gt;
##  1   132          7.9
##  2   118          7.7
##  3   119          7.7
##  4   123          7.7
##  5   136          7.7
##  6   106          7.6
##  7   131          7.4
##  8   108          7.3
##  9   110          7.2
## 10   126          7.2
## # … with 51 more rows
```
---
# Filtrando linhas
- Filtrando por mais de uma condição

```r
iris %&gt;% filter(Sepal.Length &gt; 6, Species == "versicolor")
```

```
## # A tibble: 20 × 6
##    rowid Sepal.Length Sepal.Width Petal.Length Petal.Width Species   
##    &lt;int&gt;        &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;     
##  1    51          7           3.2          4.7         1.4 versicolor
##  2    52          6.4         3.2          4.5         1.5 versicolor
##  3    53          6.9         3.1          4.9         1.5 versicolor
##  4    55          6.5         2.8          4.6         1.5 versicolor
##  5    57          6.3         3.3          4.7         1.6 versicolor
##  6    59          6.6         2.9          4.6         1.3 versicolor
##  7    64          6.1         2.9          4.7         1.4 versicolor
##  8    66          6.7         3.1          4.4         1.4 versicolor
##  9    69          6.2         2.2          4.5         1.5 versicolor
## 10    72          6.1         2.8          4           1.3 versicolor
## 11    73          6.3         2.5          4.9         1.5 versicolor
## 12    74          6.1         2.8          4.7         1.2 versicolor
## 13    75          6.4         2.9          4.3         1.3 versicolor
## 14    76          6.6         3            4.4         1.4 versicolor
## 15    77          6.8         2.8          4.8         1.4 versicolor
## 16    78          6.7         3            5           1.7 versicolor
## 17    87          6.7         3.1          4.7         1.5 versicolor
## 18    88          6.3         2.3          4.4         1.3 versicolor
## 19    92          6.1         3            4.6         1.4 versicolor
## 20    98          6.2         2.9          4.3         1.3 versicolor
```

---
# Filtrando linhas

- Filtrando por mais de uma categoria

```r
iris %&gt;% filter(Species %in% c("setosa", "versicolor"))
```

```
## # A tibble: 100 × 6
##    rowid Sepal.Length Sepal.Width Petal.Length Petal.Width Species
##    &lt;int&gt;        &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
##  1     1          5.1         3.5          1.4         0.2 setosa 
##  2     2          4.9         3            1.4         0.2 setosa 
##  3     3          4.7         3.2          1.3         0.2 setosa 
##  4     4          4.6         3.1          1.5         0.2 setosa 
##  5     5          5           3.6          1.4         0.2 setosa 
##  6     6          5.4         3.9          1.7         0.4 setosa 
##  7     7          4.6         3.4          1.4         0.3 setosa 
##  8     8          5           3.4          1.5         0.2 setosa 
##  9     9          4.4         2.9          1.4         0.2 setosa 
## 10    10          4.9         3.1          1.5         0.1 setosa 
## # … with 90 more rows
```
---
# Modificando colunas

- Função `mutate()` para criar e modificar colunas

- Primeiro modificando:

```r
iris %&gt;%
  mutate(
    Sepal.Length = Sepal.Length*10, 
    Petal.Length = Petal.Length*10
  )
```

```
## # A tibble: 150 × 6
##    rowid Sepal.Length Sepal.Width Petal.Length Petal.Width Species
##    &lt;int&gt;        &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
##  1     1           51         3.5           14         0.2 setosa 
##  2     2           49         3             14         0.2 setosa 
##  3     3           47         3.2           13         0.2 setosa 
##  4     4           46         3.1           15         0.2 setosa 
##  5     5           50         3.6           14         0.2 setosa 
##  6     6           54         3.9           17         0.4 setosa 
##  7     7           46         3.4           14         0.3 setosa 
##  8     8           50         3.4           15         0.2 setosa 
##  9     9           44         2.9           14         0.2 setosa 
## 10    10           49         3.1           15         0.1 setosa 
## # … with 140 more rows
```

---
# Modificando colunas
- Criando colunas:

```r
iris %&gt;% 
  mutate(
    Sepal.Length_mm = Sepal.Length*10, 
    Petal.Length_mm = Petal.Length*10
  )
```

```
## # A tibble: 150 × 8
##    rowid Sepal.Length Sepal.Width Petal.Length Petal.Width Species
##    &lt;int&gt;        &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
##  1     1          5.1         3.5          1.4         0.2 setosa 
##  2     2          4.9         3            1.4         0.2 setosa 
##  3     3          4.7         3.2          1.3         0.2 setosa 
##  4     4          4.6         3.1          1.5         0.2 setosa 
##  5     5          5           3.6          1.4         0.2 setosa 
##  6     6          5.4         3.9          1.7         0.4 setosa 
##  7     7          4.6         3.4          1.4         0.3 setosa 
##  8     8          5           3.4          1.5         0.2 setosa 
##  9     9          4.4         2.9          1.4         0.2 setosa 
## 10    10          4.9         3.1          1.5         0.1 setosa 
## # … with 140 more rows, and 2 more variables: Sepal.Length_mm &lt;dbl&gt;,
## #   Petal.Length_mm &lt;dbl&gt;
```
---
# Sumarizando a base

- Pela função `summarise()` podemos resumir nossa base para alguma métrica de interesse
- Média, mediana, desvio padrão, etc.
- Podemos fazer isso para um ou mais colunas de interesse


```r
# media e desvio padrao do Sepal.Length
iris %&gt;% 
  summarise(
    media_sepal_lenght = mean(Sepal.Length),
    sd_sepal_lenght = sd(Sepal.Length),
    media_sepal_width = mean(Sepal.Width),
    sd_sepal_width = sd(Sepal.Width),
    n = n()
  )
```

```
## # A tibble: 1 × 5
##   media_sepal_lenght sd_sepal_lenght media_sepal_width sd_sepal_width     n
##                &lt;dbl&gt;           &lt;dbl&gt;             &lt;dbl&gt;          &lt;dbl&gt; &lt;int&gt;
## 1               5.84           0.828              3.06          0.436   150
```


---
# Sumarizando a base

- Podemos juntar o `summarise()` com o `group_by()` para tratar cada grupo como se fosse uma base de dados diferente.

- Isso também é válido para o `mutate()`.


```r
iris %&gt;% 
  group_by(Species) %&gt;% 
  summarise(
    media_sepal_lenght = mean(Sepal.Length),
    sd_sepal_lenght = sd(Sepal.Length),
    media_sepal_width = mean(Sepal.Width),
    sd_sepal_width = sd(Sepal.Width),
    n = n()
  )
```

```
## # A tibble: 3 × 6
##   Species media_sepal_len… sd_sepal_lenght media_sepal_wid… sd_sepal_width     n
##   &lt;fct&gt;              &lt;dbl&gt;           &lt;dbl&gt;            &lt;dbl&gt;          &lt;dbl&gt; &lt;int&gt;
## 1 setosa              5.01           0.352             3.43          0.379    50
## 2 versic…             5.94           0.516             2.77          0.314    50
## 3 virgin…             6.59           0.636             2.97          0.322    50
```

---
# Outras funções do dplyr

- `accross()`: facilita aplicar uma mesma operação em várias colunas.

- `rowwise()`: operações por linha.

- `relocate()`: reposicionar colunas


---
class: inverse, center, middle

# Tidyr

---
#Tidyr
- Bom pacote para transformar bases bagunçadas em bases *tidy*

- Também usado para modificar a estrutura dos dados (pivotagem)

- Principais funções:

  -`separate()` e `unite()`:para separar variáveis concatenadas em uma única coluna ou uni-las.
  
  - `pivot_wider()` e `pivot_longer()`: para pivotar a base.
  
---
# `separate()`e `unite()`

- Função `separate()`: separa duas ou mais variáveis que estão concatenadas em uma mesma coluna:

```r
dados %&gt;% 
  separate( 
    col = coluna_velha, 
    into = c("colunas", "novas"),
    sep = "separador"
  )
```

- Função `unite()`: concatena os valores de várias variáveis em uma única coluna:

```r
dados %&gt;% 
  unite(
    col = coluna_nova, 
    colunas_para_juntar, 
    sep = "separador" 
  )
```

---
# Pivotagem

- `pivot_longer()`: alonga/empilha os dados:

```r
iris_longer &lt;- iris %&gt;% 
  pivot_longer(c(-Species, -rowid), names_to = "partes", values_to = "medidas")
iris_longer
```

```
## # A tibble: 600 × 4
##    rowid Species partes       medidas
##    &lt;int&gt; &lt;fct&gt;   &lt;chr&gt;          &lt;dbl&gt;
##  1     1 setosa  Sepal.Length     5.1
##  2     1 setosa  Sepal.Width      3.5
##  3     1 setosa  Petal.Length     1.4
##  4     1 setosa  Petal.Width      0.2
##  5     2 setosa  Sepal.Length     4.9
##  6     2 setosa  Sepal.Width      3  
##  7     2 setosa  Petal.Length     1.4
##  8     2 setosa  Petal.Width      0.2
##  9     3 setosa  Sepal.Length     4.7
## 10     3 setosa  Sepal.Width      3.2
## # … with 590 more rows
```

---
# Pivotagem

- `pivot_wider()`: alarga/espalha os dados:

```r
iris_longer %&gt;% 
  pivot_wider(id_cols = rowid, names_from = partes, values_from = medidas)
```

```
## # A tibble: 150 × 5
##    rowid Sepal.Length Sepal.Width Petal.Length Petal.Width
##    &lt;int&gt;        &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;
##  1     1          5.1         3.5          1.4         0.2
##  2     2          4.9         3            1.4         0.2
##  3     3          4.7         3.2          1.3         0.2
##  4     4          4.6         3.1          1.5         0.2
##  5     5          5           3.6          1.4         0.2
##  6     6          5.4         3.9          1.7         0.4
##  7     7          4.6         3.4          1.4         0.3
##  8     8          5           3.4          1.5         0.2
##  9     9          4.4         2.9          1.4         0.2
## 10    10          4.9         3.1          1.5         0.1
## # … with 140 more rows
```
---
class: inverse, center, middle

# Ggplot

---
# Ggplot2
- Fruto da tese de doutorado de Hadley Wickham

--

- `Gráfico estatístico`

--

- Elementos de um gráfico são as suas camadas

--

- Construção de um gráfico se dá pela sobreposição dessas camadas.

--

- `{ggplot2}`: Construir um gráfico camada por camada

--
## Vantagens sobre o R-base

- Gráficos mais bonitos

--

- Fácil personalização

--

- Aprendizado intuitivo

--

- Diferença no código entre tipos de gráficos diferentes é pequena

---
# Primeira camada

- A primeira camada é dado pela função `ggplot()`

```r
ggplot(data = iris)
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-28-1.png" width="60%" height="60%" style="display: block; margin: auto;" /&gt;

---
# Gráfico de pontos

- Precisamos especificar como as observações serão mapeadas no gráfico

- Especificar quais formas geométricas serão utilizadas


```r
ggplot(iris) +
  geom_point(mapping = aes(x = Sepal.Length, y = Sepal.Width))
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-29-1.png" width="60%" height="60%" style="display: block; margin: auto;" /&gt;
---
# Gráfico de pontos
- Adicionando uma reta `\(y = -6 + 1.5x\)`


```r
ggplot(iris) +
  geom_abline(intercept = -6, slope = 1.5, color = "red") +
  geom_point(mapping = aes(x = Sepal.Length, y = Sepal.Width))
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-30-1.png" width="60%" height="60%" style="display: block; margin: auto;" /&gt;

---
# Gráfico de pontos
- Mapear a cor dos pontos de acordo com outra variável

```r
# variavel continua
iris %&gt;%
ggplot() +
  geom_point(mapping = aes(x = Sepal.Length, y = Sepal.Width, color = Petal.Width))
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-31-1.png" width="60%" height="60%" style="display: block; margin: auto;" /&gt;
---
# Gráfico de pontos
- Para fator/variável categórica

```r
# fator
iris %&gt;%
ggplot() +
  geom_point(mapping = aes(x = Sepal.Length, y = Sepal.Width, color = Species))
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-32-1.png" width="60%" height="60%" style="display: block; margin: auto;" /&gt;

---
# Gráfico de pontos
- Única cor para tudo

```r
# fator
iris %&gt;%
ggplot() +
  geom_point(mapping = aes(x = Sepal.Length, y = Sepal.Width), color = "blue")
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-33-1.png" width="60%" height="60%" style="display: block; margin: auto;" /&gt;
---
# Gráfico de barras

- Criando nova categoria para ser plotada


```r
# frequencia de categorias de comprimento de sepalas e petalas
iris_novo &lt;- iris %&gt;% 
  mutate(Sepal_cat = case_when(Sepal.Length &lt; 5~ "Menor que 5",
                   Sepal.Length &gt;= 5 &amp; Sepal.Length &lt; 6 ~ "Maior que 5, menor que 6",
                   Sepal.Length &gt;= 6 ~ "Maior/igual a 6"))
```

---
# Gráfico de barras

- Devemos mudar a forma geométrica que queremos representar

```r
iris_novo %&gt;%
  count(Sepal_cat) %&gt;%
  ggplot() +
  geom_col(aes(x = Sepal_cat, y = n))
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-35-1.png" width="60%" height="60%" style="display: block; margin: auto;" /&gt;

---
# Gráfico de barras

- Preencher barras de acordo com a categoria


```r
iris_novo %&gt;%
  count(Sepal_cat) %&gt;%
  ggplot() +
  geom_col(aes(x = Sepal_cat, y = n, fill = Sepal_cat), show.legend = FALSE)
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-36-1.png" width="60%" height="60%" style="display: block; margin: auto;" /&gt;

---
# Gráfico de barras

- Inverter gráfico de barras


```r
iris_novo %&gt;%
  count(Sepal_cat) %&gt;%
  ggplot() +
  geom_col(aes(y = Sepal_cat, x = n, fill = Sepal_cat), show.legend = FALSE)
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-37-1.png" width="60%" height="60%" style="display: block; margin: auto;" /&gt;

---
# Gráfico de barras

- Colocando número da frequência em cada barra

```r
iris_novo %&gt;%
  count(Sepal_cat) %&gt;% ggplot() +
  geom_col(aes(x = Sepal_cat, y = n, fill = Sepal_cat), show.legend = FALSE) +
  geom_label(aes(x = Sepal_cat, y = n/2, label = n)) +
  coord_flip()
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-38-1.png" width="50%" height="50%" style="display: block; margin: auto;" /&gt;
---
# Gráfico de barras

- Reordenando as barras

```r
iris_novo %&gt;%
  count(Sepal_cat) %&gt;%
  mutate(Sepal_cat = forcats::fct_reorder(Sepal_cat, n)) %&gt;% ggplot() +
  geom_col(aes(x = Sepal_cat, y = n, fill = Sepal_cat), show.legend = FALSE) +
  geom_label(aes(x = Sepal_cat, y = n/2, label = n)) +
  coord_flip()
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-39-1.png" width="50%" height="50%" style="display: block; margin: auto;" /&gt;


---
# Histogramas e boxplots
- Histograma rápido

```r
iris %&gt;% 
  filter(Species == "setosa") %&gt;%
  ggplot() +
  geom_histogram(aes(x = Sepal.Length))
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-40-1.png" width="60%" height="60%" style="display: block; margin: auto;" /&gt;

---
# Histogramas e boxplots
- Fixando largura da banda

```r
iris %&gt;% 
  filter(Species == "setosa") %&gt;%
  ggplot() +
  geom_histogram(aes(x = Sepal.Length), binwidth = 0.25, color = "white")
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-41-1.png" width="60%" height="60%" style="display: block; margin: auto;" /&gt;

---
# Histogramas e boxplots
- Boxplots por Species

```r
iris %&gt;% 
  ggplot() +
  geom_boxplot(aes(x = Species, y = Sepal.Length))
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-42-1.png" width="60%" height="60%" style="display: block; margin: auto;" /&gt;

---
# Histogramas e boxplots
- Invertido

```r
iris %&gt;% 
  ggplot() +
  geom_boxplot(aes(x = Species, y = Sepal.Length))+
  coord_flip()
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-43-1.png" width="60%" height="60%" style="display: block; margin: auto;" /&gt;

---
# Títulos e labels

```r
iris %&gt;%
ggplot() +
  geom_point(mapping = aes(x = Sepal.Length, y = Sepal.Width, color = Species))+
  labs(x = "Comprimento de Sépala", y = "Largura de Sépala",
       color = "Espécies", title = "Gráfico de dispersão",
       subtitle = "Largura x Comprimento de Sépala")
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-44-1.png" width="60%" height="60%" style="display: block; margin: auto;" /&gt;
---
# Escalas
- Quebras (ticks) dos eixos x e y

```r
iris %&gt;%
ggplot() +
  geom_point(mapping = aes(x = Sepal.Length, y = Sepal.Width))+
  scale_x_continuous(breaks = seq(4, 8, 0.5)) +
  scale_y_continuous(breaks = seq(2, 4.5, 0.5))
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-45-1.png" width="55%" height="55%" style="display: block; margin: auto;" /&gt;

---
# Escalas
- Alterando limites

```r
iris %&gt;%
ggplot() +
  geom_point(mapping = aes(x = Sepal.Length, y = Sepal.Width))+
  scale_x_continuous(breaks = seq(4, 8, 0.5)) +
  scale_y_continuous(breaks = seq(2, 4.5, 0.5)) + coord_cartesian(ylim = c(1, 6))
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-46-1.png" width="55%" height="55%" style="display: block; margin: auto;" /&gt;

---
# Escalas
- Escalas de cores

```r
iris_novo %&gt;%
  count(Sepal_cat) %&gt;%
  ggplot() +
  geom_col(aes(y = Sepal_cat, x = n, fill = Sepal_cat), show.legend = FALSE)+
  scale_fill_manual(values = c("red", "blue", "green"))
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-47-1.png" width="55%" height="55%" style="display: block; margin: auto;" /&gt;

---
# Escalas
- Gradientes

```r
iris %&gt;%
ggplot() +
  geom_point(mapping = aes(x = Sepal.Length, y = Sepal.Width, color = Petal.Width))+
  scale_color_gradient(low = "red", high = "green")
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-48-1.png" width="55%" height="55%" style="display: block; margin: auto;" /&gt;

---
# Escalas
- Mudando nome de categorias

```r
iris_novo %&gt;%
  count(Sepal_cat) %&gt;%
  ggplot() +
  geom_col(aes(y = Sepal_cat, x = n, fill = Sepal_cat))+
  scale_fill_discrete(labels = c("Cat1", "Cat2", "Cat3"))
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-49-1.png" width="55%" height="55%" style="display: block; margin: auto;" /&gt;

---
# Temas
- O tema usado até agora é o tema padrão do ggplot
- Podemos mudar isso, usando por exemplo `theme_minimal()`

```r
iris %&gt;%
ggplot() +
  geom_point(mapping = aes(x = Sepal.Length, y = Sepal.Width))+
  theme_minimal()
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-50-1.png" width="55%" height="55%" style="display: block; margin: auto;" /&gt;

---
# Temas
- Tema em preto e branco `theme_bw()`

```r
iris %&gt;%
ggplot() +
  geom_point(mapping = aes(x = Sepal.Length, y = Sepal.Width))+
  theme_bw()
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-51-1.png" width="55%" height="55%" style="display: block; margin: auto;" /&gt;

---
# Temas
- Tema do R base `theme_classic()`

```r
iris %&gt;%
ggplot() +
  geom_point(mapping = aes(x = Sepal.Length, y = Sepal.Width))+
  theme_classic()
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-52-1.png" width="55%" height="55%" style="display: block; margin: auto;" /&gt;

---
# Temas
- Tema escuro`theme_dark()`

```r
iris %&gt;%
ggplot() +
  geom_point(mapping = aes(x = Sepal.Length, y = Sepal.Width))+
  theme_minimal()
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-53-1.png" width="55%" height="55%" style="display: block; margin: auto;" /&gt;
---
# Juntando gráficos
- Podemos adicionar varios `geoms` em um mesmo gráfico

```r
iris %&gt;%
ggplot(aes(x = Sepal.Length, y = Sepal.Width)) +
  geom_point()+
  geom_smooth(se = FALSE, method = "lm")
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-54-1.png" width="55%" height="55%" style="display: block; margin: auto;" /&gt;

---
# Juntando gráficos
- Paineis de acordo com variaveis categóricas

```r
iris %&gt;%
ggplot() +
  geom_point(mapping = aes(x = Sepal.Length, y = Sepal.Width)) +
  facet_wrap(~Species, ncol = 3)
```

&lt;img src="slides_tidyverse_files/figure-html/unnamed-chunk-55-1.png" width="55%" height="55%" style="display: block; margin: auto;" /&gt;
---
class: inverse, center, middle

# Muito obrigado!

---
# Referências

- [Livro da Curso-R, capítulos 6, 7 e 8](https://livro.curso-r.com/index.html)

- [A tidyverse Cookbook](https://rstudio-education.github.io/tidyverse-cookbook/how-to-use-this-book.html#tidy-data)

- [R for data science](https://r4ds.had.co.nz/tibbles.html)
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="libs/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"slideNumberFormat": "%current%",
"highlightStyle": "github",
"highlightLines": true,
"ratio": "16:9",
"countIncrementalSlides": true
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
